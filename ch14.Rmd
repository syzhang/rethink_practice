---
title: "Rethink chapter 14 practice"
output: html_notebook
---

14H1

Fit a model with both varying intercepts by district_id and varying slopes of urban (as a 0/1 indicator variable) by district_id. You are still predicting use.contraception.

```{r}
library(rethinking)
data(bangladesh)
d <- bangladesh
d
```
```{r}
dat_list <- list(
    C = d$use.contraception,
    did = as.integer( as.factor(d$district) ),
    urban = d$urban
)
```

```{r}
m1.1 <- ulam(
    alist(
        C ~ bernoulli( p ),
        logit(p) <- a[did] + b[did]*urban,
        c(a,b)[did] ~ multi_normal( c(abar,bbar) , Rho , Sigma ),
        abar ~ normal(0,1),
        bbar ~ normal(0,0.5),
        Rho ~ lkj_corr(2),
        Sigma ~ exponential(1)
    ) , data=dat_list , chains=4 , cores=4 , cmdstan=TRUE )
```
Inspect the correlation between the intercepts and slopes. Can you interpret this correlation, in terms of what it tells you about the pattern of contraceptive use in the sample?

```{r}
precis( m1.1)
```
urban areas use contraception more.

```{r}
precis( m1.1, depth = 3, pars=c('Rho', 'Sigma'))
```
Rho correlation between intercept and slope are negative, plotting samples below

```{r}
post <- extract.samples(m1.1)
a <- apply( post$a , 2 , mean )
b <- apply( post$b , 2 , mean )
plot( a, b , xlab="a (intercept)" , ylab="b (urban slope)" )
abline( h=0 , lty=2 )
abline( v=0 , lty=2 )
```
```{r}
u0 <- inv_logit( a )
u1 <- inv_logit( a + b )
plot( u0 , u1 , xlim=c(0,1) , ylim=c(0,1) , xlab="urban = 0" , ylab="urban = 1" ) 
abline( h=0.5 , lty=2 )
abline( v=0.5 , lty=2 )
```
probability of using contraception, x axis = probability in rural areas of the district, y axis = probability in urban areas of a district. More variation (and lower than chance) in rural areas, while around 0.5 for urban areas.



14.2

Now consider the predictor variables age.centered and living.children.

Draw a DAG reflecting these relationships (A - age, C - contraception, K - kids)
```{r}
library(dagitty)
dag <- dagitty( "dag {
  A -> C
  A -> K
  K -> C
}")
coordinates(dag) <- list( x=c(A=0, K=2, C=1), y=c(A=0, K=0, C=1))
drawdag( dag )
```
Build a model of the DAG
```{r}
dat_list$children <- standardize( d$living.children )
dat_list$age <- standardize( d$age.centered )
```

```{r}
m2.1 <- ulam(
    alist(
        C ~ bernoulli( p ),
        logit(p) <- a[did] + b[did]*urban + bA*age,
        c(a,b)[did] ~ multi_normal( c(abar,bbar) , Rho , Sigma ),
        abar ~ normal(0,1),
        c(bbar,bA) ~ normal(0,0.5),
        Rho ~ lkj_corr(2),
        Sigma ~ exponential(1)
    ) , data=dat_list , chains=4 , cores=4 , cmdstan=TRUE )
```

```{r}
m2.2 <- ulam(
    alist(
        C ~ bernoulli( p ),
        logit(p) <- a[did] + b[did]*urban + bK*children + bA*age,
        c(a,b)[did] ~ multi_normal( c(abar,bbar) , Rho , Sigma ),
        abar ~ normal(0,1),
        c(bbar,bK,bA) ~ normal(0,0.5),
        Rho ~ lkj_corr(2),
        Sigma ~ exponential(1)
    ) , data=dat_list , chains=4 , cores=4 , cmdstan=TRUE )
```

m2.1 has age alone (plus urban and intercept), m2.2 has children and age
```{r}
precis(m2.1)
```
```{r}
precis(m2.2)
```
m2.1 shows age has a slight positive effect to contraceptive use.
m2.2 shows age effect is negative and fairly strong, effect of kids is positive and strong. When controlling for kids, age actually has opposite effect.


14H3

Modify models from 14H2, model the variables as monotonic ordered categories for kids.

```{r}
dat_list$K <- d$living.children
dat_list$alpha <- rep(2,3)
dat_list$alpha
```

building ordered categories (book p394, R code 12.34)

```{r}
m3.1 <- ulam(
    alist(
        C ~ bernoulli( p ),
        logit(p) <- a[did] + b[did]*urban + bK*sum( delta_shell[1:K] ) + bA*age,
        c(a,b)[did] ~ multi_normal( c(abar,bbar) , Rho , Sigma ),
        abar ~ normal(0,1),
        c(bbar,bK,bA) ~ normal(0,0.5),
        Rho ~ lkj_corr(2),
        Sigma ~ exponential(1),
        vector[4]: delta_shell <<- append_row( 0 , delta ),
        simplex[3]: delta ~ dirichlet( alpha )
    ) , data=dat_list , chains=4 , cores=4 , cmdstan=TRUE )
```

```{r}
precis(m3.1)
```
again similar to m2.2, age negative, kids positive effects.

```{r}
precis(m3.1, 3, pars='delta')
```

having 1 kid has the greatest effect
