---
title: "Rethink chapter 6 practice"
output: 
  html_document:
    keep_md: true
#output: html_notebook
---

Problem 6H1

```{r}
library(dagitty)
library(rethinking)

dag_6.2 <- dagitty( "dag {
  A -> D
  A -> M -> D
  A <- S -> M
  S -> W -> D
}")
coordinates(dag_6.2) <- list( x=c(S=0, W=2, M=1, A=0, D=2), y=c(S=0, W=0, M=1, A=2, D=2))
drawdag( dag_6.2 )
```

Identifying all paths from W to D
```{r}
paths(dag_6.2, from ="W", to = "D", Z = list(), limit = 100,
  directed = FALSE)
```

Check conditional independence
```{r}
impliedConditionalIndependencies( dag_6.2)
```

Check how to close open backdoor paths (condition on S)
```{r}
adjustmentSets( dag_6.2 , exposure="W" , outcome="D" )
```

Loading data to fit models
```{r}
data("WaffleDivorce", package = "rethinking")
d <- WaffleDivorce
d
```
```{r}
d$WaffleHouses
```


```{r}
d$d <- standardize( d$Divorce )
d$m <- standardize( d$Marriage )
d$a <- standardize( d$MedianAgeMarriage )
d$w <- standardize( d$WaffleHouses)
d$s <- d$South
```

Fitting various models for comparison
```{r}
m5.1 <- quap( alist(
  d ~ dnorm( mu , sigma ) , 
  mu <- intercept + bW * w ,
  intercept ~ dnorm( 0 , 0.2 ) , 
  bW ~ dnorm( 0 , 0.5 ) , 
  sigma ~ dexp( 1 )
) , data = d )
precis( m5.1)
```

```{r}
m5.2 <- quap( alist(
  d ~ dnorm( mu , sigma ) , 
  mu <- intercept + bW * w + bM * m,
  intercept ~ dnorm( 0 , 0.2 ) , 
  bW ~ dnorm( 0 , 0.5 ) , 
  bM ~ dnorm( 0 , 0.5 ) , 
  sigma ~ dexp( 1 )
) , data = d )
precis( m5.2)
```

```{r}
m5.3 <- quap( alist(
  d ~ dnorm( mu , sigma ) , 
  mu <- intercept + bW * w + bA * a,
  intercept ~ dnorm( 0 , 0.2 ) , 
  bW ~ dnorm( 0 , 0.5 ) , 
  bA ~ dnorm( 0 , 0.5 ) , 
  sigma ~ dexp( 1 )
) , data = d )
precis( m5.3)
```

```{r}
m5.4 <- quap( alist(
  d ~ dnorm( mu , sigma ) , 
  mu <- intercept + bW * w + bS * s,
  intercept ~ dnorm( 0 , 0.2 ) , 
  bW ~ dnorm( 0 , 0.5 ) , 
  bS ~ dnorm( 0 , 0.5 ) , 
  sigma ~ dexp( 1 )
) , data = d )
precis( m5.4)
```

```{r}
m5.5 <- quap( alist(
  d ~ dnorm( mu , sigma ) , 
  mu <- intercept + bW * w + bA * a + bM * m,
  intercept ~ dnorm( 0 , 0.2 ) , 
  bW ~ dnorm( 0 , 0.5 ) , 
  bA ~ dnorm( 0 , 0.5 ) , 
  bM ~ dnorm( 0 , 0.5 ) , 
  sigma ~ dexp( 1 )
) , data = d )
precis( m5.5)
```

Plotting the coefficient of bW, the last 2 models that closed the backdoor paths are showing that W isn't really correlated with D, while the other models do. m5.4 that conditioned on S has a clearer effect comparing to m5.5 that conditioned on A and M. 
```{r}
coeftab_plot( coeftab(m5.1, m5.2, m5.3, m5.4, m5.5), pars = "bW")
```





Using tidyverse below

load tidyverse
```{r}
library(tidyverse)
library(ggdag)
```

```{r}
data("WaffleDivorce", package = "rethinking")
d <- WaffleDivorce
d
```

```{r}
# standardize the continuous focal variables.
d <-
  d %>% 
  mutate(a = rethinking::standardize(MedianAgeMarriage),
         d = rethinking::standardize(Divorce),
         m = rethinking::standardize(Marriage),
         s = factor(South, levels = 0:1, labels = c("North", "South")),
         w = rethinking::standardize(WaffleHouses))

```

```{r}
library(GGally)
# define a couple custom functions
my_diag <- function(data, mapping, ...) {
  ggplot(data = data, mapping = mapping) + 
    geom_density(fill = "steelblue", color = "black")
}

my_lower <- function(data, mapping, ...) {
  ggplot(data = data, mapping = mapping) + 
    geom_smooth(method = "lm", color = "orange", se = F) +
    geom_point(alpha = .8, size = 1/4, color = "blue")
  }

ggpairs(data = d, columns = c(14:16, 18, 17),
        upper = list(continuous = wrap("cor", family = "sans", color = "black", size = 3)),
        diag = list(continuous = my_diag),
        lower = list(continuous = my_lower),
        mapping = aes(color = s)) +
  scale_fill_manual(values = c("forestgreen", "lightblue"))
```

```{r}
library(brms)

b6.13 <- 
  brm(data = d, 
      family = gaussian,
      d ~ 1 + w,
      prior = c(prior(normal(0, 0.2), class = Intercept),
                prior(normal(0, 0.5), class = b),
                prior(exponential(1), class = sigma)),
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      seed = 6,
      file = "fits/b06.13")

b6.14 <- 
  brm(data = d, 
      family = gaussian,
      d ~ 1 + w + s,
      prior = c(prior(normal(0, 0.2), class = Intercept),
                prior(normal(0, 0.5), class = b),
                prior(exponential(1), class = sigma)),
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      seed = 6,
      file = "fits/b06.14")

b6.15 <- 
  brm(data = d, 
      family = gaussian,
      d ~ 1 + w + a + m,
      prior = c(prior(normal(0, 0.2), class = Intercept),
                prior(normal(0, 0.5), class = b),
                prior(exponential(1), class = sigma)),
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      seed = 6,
      file = "fits/b06.15")

b6.16 <- 
  brm(data = d, 
      family = gaussian,
      d ~ 1 + w + a,
      prior = c(prior(normal(0, 0.2), class = Intercept),
                prior(normal(0, 0.5), class = b),
                prior(exponential(1), class = sigma)),
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      seed = 6,
      file = "fits/b06.16")

b6.17 <- 
  brm(data = d, 
      family = gaussian,
      d ~ 1 + w + m,
      prior = c(prior(normal(0, 0.2), class = Intercept),
                prior(normal(0, 0.5), class = b),
                prior(exponential(1), class = sigma)),
      iter = 2000, warmup = 1000, chains = 4, cores = 4,
      seed = 6,
      file = "fits/b06.17")
```
```{r}

```


```{r}

gg_simple_dag <- function(d) {
  
  d %>% 
    ggplot(aes(x = x, y = y, xend = xend, yend = yend)) +
    geom_dag_point(color = "steelblue", alpha = 1/2, size = 6.5) +
    geom_dag_text(color = "black") +
    geom_dag_edges() + 
    theme_dag()
  
}

dag_coords <-
  tibble(name = c("A", "D", "M", "S", "W"),
         x    = c(1, 3, 2, 1, 3),
         y    = c(1, 1, 2, 3, 3))

dagify(A ~ S,
       D ~ A + M + W,
       M ~ A + S,
       W ~ S,
       coords = dag_coords) %>%
  gg_simple_dag()
```

Standardising all data
```{r}
d$D <- standardize(d$Divorce)
d$M <- standardize(d$Marriage)
d$A <- standardize(d$MedianAgeMarriage)
```

```{r}
d$D
```

```{r}
d$South
```
```{r}
d$WaffleHouses
```

